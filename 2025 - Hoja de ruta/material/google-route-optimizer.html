<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimizador de Rutas con Google Maps</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            box-sizing: border-box;
        }
        #map {
            flex: 1;
            border: 2px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        #controls {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
        }
        #pointsInput {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 14px;
            padding: 8px;
            box-sizing: border-box;
        }
        .button-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 15px;
            background-color: #4285F4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
        }
        button:hover {
            background-color: #3367D6;
        }
        .radio-container {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        #status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            background-color: #f1f1f1;
            min-height: 40px;
        }
        .options-container {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        label {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        h2 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #4285F4;
        }
        .instruction {
            margin-bottom: 10px;
            font-style: italic;
            color: #666;
        }
        #resultInfo {
            margin-top: 10px;
            background-color: #e8f0fe;
            padding: 10px;
            border-radius: 5px;
            border-left: 5px solid #4285F4;
            display: none;
        }
    </style>
</head>
<body>
    <div id="container">
        <h2>Optimizador de Rutas con Google Maps</h2>
        <div id="map"></div>
        <div id="controls">
            <p class="instruction">Ingresa las coordenadas en formato latitud,longitud separadas por punto y coma (nota: Google Maps usa latitud,longitud en orden inverso a OSRM)</p>
            <textarea id="pointsInput" placeholder="Ingresa las coordenadas en formato latitud,longitud separadas por punto y coma. Ejemplo:
-34.615200,-58.402300;-34.646300,-58.381500;-34.613100,-58.377200;-34.603700,-58.381600;-34.587300,-58.393900"></textarea>
            
            <div class="radio-container">
                <label><input type="radio" name="travelMode" value="DRIVING" checked> En auto</label>
                <label><input type="radio" name="travelMode" value="WALKING"> Caminando</label>
                <label><input type="radio" name="travelMode" value="BICYCLING"> En bicicleta</label>
                <label><input type="radio" name="travelMode" value="TRANSIT"> Transporte público</label>
            </div>
            
            <div class="options-container">
                <label><input type="checkbox" id="optimizeWaypoints" checked> Optimizar orden de los puntos</label>
                <label><input type="checkbox" id="returnToStart"> Volver al punto de inicio</label>
            </div>
            
            <div class="button-container">
                <button id="calculateBtn">Calcular Ruta</button>
                <button id="clearBtn">Limpiar Mapa</button>
            </div>
            
            <div id="status">Ingresa coordenadas y haz clic en "Calcular Ruta"</div>
            <div id="resultInfo"></div>
        </div>
    </div>

    <script>
        // Variables para el mapa
        let map;
        let directionsService;
        let directionsRenderer;
        let markers = [];
        
        // Inicializar Google Maps (se ejecutará cuando el script de Google Maps esté cargado)
        function initMap() {
            // Crear el mapa centrado en Buenos Aires
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -34.615200, lng: -58.402300 },
                zoom: 13,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });
            
            // Crear el servicio de direcciones y el renderizador
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: false
            });
            
            // Rellenar el textarea con el ejemplo (invertido para Google Maps)
            document.getElementById('pointsInput').value = '-34.615200,-58.402300;-34.646300,-58.381500;-34.613100,-58.377200;-34.603700,-58.381600;-34.587300,-58.393900';
            
            // Agregar eventos a los botones
            document.getElementById('calculateBtn').addEventListener('click', calculateRoute);
            document.getElementById('clearBtn').addEventListener('click', clearMap);
            
            // Agregar evento al checkbox "Volver al punto de inicio"
            document.getElementById('returnToStart').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('optimizeWaypoints').checked = true;
                }
            });
        }
        
        // Función para eliminar duplicados de coordenadas
        function removeDuplicates(points) {
            const uniquePoints = [];
            const seen = new Set();
            
            for (const point of points) {
                const key = `${point.lat},${point.lng}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniquePoints.push(point);
                }
            }
            
            return uniquePoints;
        }
        
        // Función para calcular la ruta
        function calculateRoute() {
            clearMap();
            
            // Obtener los puntos del textarea
            const inputText = document.getElementById('pointsInput').value.trim();
            const statusDiv = document.getElementById('status');
            const resultInfo = document.getElementById('resultInfo');
            resultInfo.style.display = 'none';
            
            if (!inputText) {
                statusDiv.innerHTML = 'Error: No se han ingresado coordenadas';
                statusDiv.style.color = 'red';
                return;
            }
            
            try {
                // Parsear coordenadas (formato lat,lng para Google Maps)
                const pairs = inputText.split(';');
                let points = pairs.map(pair => {
                    const [lat, lng] = pair.split(',').map(Number);
                    if (isNaN(lat) || isNaN(lng)) {
                        throw new Error(`Coordenada inválida: ${pair}`);
                    }
                    return { lat, lng };
                });
                
                // Eliminar duplicados
                const uniquePoints = removeDuplicates(points);
                if (uniquePoints.length < 2) {
                    statusDiv.innerHTML = 'Error: Se necesitan al menos 2 puntos diferentes para calcular una ruta';
                    statusDiv.style.color = 'red';
                    return;
                }
                
                // Mostrar estado
                statusDiv.innerHTML = 'Calculando ruta...';
                statusDiv.style.color = 'blue';
                
                // Crear marcadores para los puntos (serán ocultados cuando se muestre la ruta)
                uniquePoints.forEach((point, index) => {
                    const marker = new google.maps.Marker({
                        position: point,
                        map: map,
                        label: (index + 1).toString()
                    });
                    markers.push(marker);
                });
                
                // Ajustar el mapa para mostrar todos los marcadores
                const bounds = new google.maps.LatLngBounds();
                uniquePoints.forEach(point => bounds.extend(point));
                map.fitBounds(bounds);
                
                // Obtener el modo de viaje seleccionado
                const travelMode = document.querySelector('input[name="travelMode"]:checked').value;
                
                // Verificar si se debe optimizar el orden de los waypoints
                const optimizeWaypoints = document.getElementById('optimizeWaypoints').checked;
                
                // Verificar si se debe volver al punto de inicio
                const returnToStart = document.getElementById('returnToStart').checked;
                
                // Configurar origen, destino y waypoints
                let origin, destination;
                let waypoints = [];
                
                if (uniquePoints.length === 2) {
                    // Solo hay 2 puntos, origen y destino
                    origin = uniquePoints[0];
                    destination = uniquePoints[1];
                } else {
                    // Más de 2 puntos
                    if (returnToStart) {
                        // Ruta circular: origen y destino son el mismo punto
                        origin = uniquePoints[0];
                        destination = uniquePoints[0];
                        waypoints = uniquePoints.slice(1).map(point => ({
                            location: point,
                            stopover: true
                        }));
                    } else {
                        // Ruta no circular: primer y último punto como origen y destino
                        origin = uniquePoints[0];
                        destination = uniquePoints[uniquePoints.length - 1];
                        waypoints = uniquePoints.slice(1, uniquePoints.length - 1).map(point => ({
                            location: point,
                            stopover: true
                        }));
                    }
                }
                
                // Crear la solicitud de ruta
                const request = {
                    origin: origin,
                    destination: destination,
                    waypoints: waypoints,
                    optimizeWaypoints: optimizeWaypoints,
                    travelMode: google.maps.TravelMode[travelMode]
                };
                
                // Obtener la ruta
                directionsService.route(request, function(response, status) {
                    if (status === 'OK') {
                        // Ocultar los marcadores creados anteriormente
                        markers.forEach(marker => marker.setMap(null));
                        markers = [];
                        
                        // Mostrar la ruta
                        directionsRenderer.setDirections(response);
                        
                        // Mostrar información de la ruta
                        const route = response.routes[0];
                        let totalDistance = 0;
                        let totalDuration = 0;
                        
                        // Calcular distancia y duración totales
                        route.legs.forEach(leg => {
                            totalDistance += leg.distance.value;
                            totalDuration += leg.duration.value;
                        });
                        
                        // Convertir a unidades más amigables
                        const distanceKm = (totalDistance / 1000).toFixed(2);
                        const durationMin = Math.floor(totalDuration / 60);
                        const durationHr = Math.floor(durationMin / 60);
                        const durationMinRem = durationMin % 60;
                        
                        // Mostrar información de la ruta
                        statusDiv.innerHTML = `Ruta calculada correctamente`;
                        statusDiv.style.color = 'green';
                        
                        // Mostrar información detallada
                        resultInfo.style.display = 'block';
                        resultInfo.innerHTML = `
                            <strong>Distancia total:</strong> ${distanceKm} km<br>
                            <strong>Duración estimada:</strong> ${durationHr > 0 ? `${durationHr} h ${durationMinRem} min` : `${durationMin} min`}<br>
                            <strong>Número de paradas:</strong> ${waypoints.length}
                        `;
                        
                        // Si se optimizó el orden, mostrar el orden optimizado
                        if (optimizeWaypoints && waypoints.length > 0) {
                            const waypointOrder = route.waypoint_order;
                            let orderText = '<strong>Orden optimizado:</strong> ';
                            orderText += waypointOrder.map(index => index + 2).join(' → ');
                            resultInfo.innerHTML += `<br>${orderText}`;
                        }
                    } else {
                        // Error al calcular la ruta
                        statusDiv.innerHTML = `Error al calcular la ruta: ${status}`;
                        statusDiv.style.color = 'red';
                        
                        // Mostrar mensaje según el error
                        if (status === 'ZERO_RESULTS') {
                            statusDiv.innerHTML += '<br>No se pudo encontrar una ruta entre los puntos especificados.';
                        } else if (status === 'MAX_WAYPOINTS_EXCEEDED') {
                            statusDiv.innerHTML += '<br>Se ha excedido el número máximo de waypoints (Google Maps limita a 23).';
                        }
                    }
                });
                
            } catch (error) {
                statusDiv.innerHTML = `Error: ${error.message}`;
                statusDiv.style.color = 'red';
            }
        }
        
        // Función para limpiar el mapa
        function clearMap() {
            // Eliminar marcadores
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // Eliminar ruta
            directionsRenderer.set('directions', null);
            
            // Actualizar estado
            document.getElementById('status').innerHTML = 'Mapa limpiado';
            document.getElementById('status').style.color = 'black';
            document.getElementById('resultInfo').style.display = 'none';
        }
    </script>
    
    <!-- Cargar Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDNVUkKD_VUKhMFEWcUcZvWRHLVQiMjMu0&callback=initMap"></script>
</body>
</html>